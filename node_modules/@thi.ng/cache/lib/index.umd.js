!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@thi.ng/dcons"),require("@thi.ng/transducers")):"function"==typeof define&&define.amd?define(["exports","@thi.ng/dcons","@thi.ng/transducers"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).thi=t.thi||{},t.thi.ng=t.thi.ng||{},t.thi.ng.cache={}),t.thi.ng.dcons,t.thi.ng.transducers)}(this,(function(t,e,s){"use strict";class i{constructor(t,s){const i=Object.assign({maxlen:1/0,maxsize:1/0,map:()=>new Map,ksize:()=>0,vsize:()=>0},s);this.map=i.map(),this.items=new e.DCons,this._size=0,this.opts=i,t&&this.into(t)}get length(){return this.items.length}get size(){return this._size}[Symbol.iterator](){return this.entries()}entries(){return s.map((t=>[t.k,t]),this.items)}keys(){return s.map((t=>t.k),this.items)}values(){return s.map((t=>t.v),this.items)}copy(){const t=this.empty();t.items=this.items.copy();let e=t.items.head;for(;e;)t.map.set(e.value.k,e),e=e.next;return t}empty(){return new i(null,this.opts)}release(){this._size=0,this.map.clear();const t=this.opts.release;if(t){let e;for(;e=this.items.drop();)t(e.k,e.v);return!0}return this.items.release()}has(t){return this.map.has(t)}get(t,e){const s=this.map.get(t);return s?this.resetEntry(s):e}set(t,e){const s=this.opts.ksize(t)+this.opts.vsize(e),i=this.map.get(t);return this._size+=Math.max(0,s-(i?i.value.s:0)),this.ensureSize()&&this.doSetEntry(i,t,e,s),e}into(t){for(let e of t)this.set(e[0],e[1]);return this}getSet(t,e){const s=this.map.get(t);return s?Promise.resolve(this.resetEntry(s)):e().then((e=>this.set(t,e)))}delete(t){const e=this.map.get(t);return!!e&&(this.removeEntry(e),!0)}resetEntry(t){return this.items.asTail(t),t.value.v}ensureSize(){const t=this.opts.release,e=this.opts.maxsize,s=this.opts.maxlen;for(;this._size>e||this.length>=s;){const e=this.items.drop();if(!e)return!1;this.map.delete(e.k),t&&t(e.k,e.v),this._size-=e.s}return!0}removeEntry(t){const e=t.value;this.map.delete(e.k),this.items.remove(t),this.opts.release&&this.opts.release(e.k,e.v),this._size-=e.s}doSetEntry(t,e,s,i){t?(t.value.v=s,t.value.s=i,this.items.asTail(t)):(this.items.push({k:e,v:s,s:i}),this.map.set(e,this.items.tail))}}class r extends i{constructor(t,e){super(t,e)}empty(){return new r(null,this.opts)}resetEntry(t){return this.items.asHead(t),t.value.v}doSetEntry(t,e,s,i){t?(t.value.v=s,t.value.s=i,this.items.asHead(t)):(this.items.cons({k:e,v:s,s:i}),this.map.set(e,this.items.head))}}class n extends i{constructor(t,e){super(t,e=Object.assign({ttl:36e5},e))}empty(){return new n(null,this.opts)}has(t){return void 0!==this.get(t)}get(t,e){const s=this.map.get(t);if(s){if(s.value.t>=Date.now())return this.resetEntry(s);this.removeEntry(s)}return e}set(t,e,s=this.opts.ttl){const i=this.opts.ksize(t)+this.opts.vsize(e),r=this.map.get(t);if(this._size+=Math.max(0,i-(r?r.value.s:0)),this.ensureSize()){const n=Date.now()+s;r?(r.value.v=e,r.value.s=i,r.value.t=n,this.items.asTail(r)):(this.items.push({k:t,v:e,s:i,t:n}),this.map.set(t,this.items.tail))}return e}getSet(t,e,s=this.opts.ttl){const i=this.get(t);return i?Promise.resolve(i):e().then((e=>this.set(t,e,s)))}prune(){const t=Date.now();let e=this.items.head;for(;e;)e.value.t<t&&this.removeEntry(e),e=e.next}ensureSize(){const t=this.opts.maxsize,e=this.opts.maxlen,s=Date.now();let i=this.items.head;for(;i&&(this._size>t||this.length>=e);)i.value.t<s&&this.removeEntry(i),i=i.next;return super.ensureSize()}}t.LRUCache=i,t.MRUCache=r,t.TLRUCache=n,Object.defineProperty(t,"__esModule",{value:!0})}));